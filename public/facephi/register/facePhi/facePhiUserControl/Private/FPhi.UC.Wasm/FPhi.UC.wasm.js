if(!FPhi)var FPhi={};class ResourceManager{constructor(e,t,i,r,o,s,n){var l="";this.status=0,this.logDebug=!1,this.eventStatus=r,this.caller=i,this.baseURL=e,0<t.length&&(l=t+"."),this.widgetLoaded=0,this.languageCustomLoaded=0,this.languageDefaultLoaded=0,this.urlWidget=e+"widget.xml",this.urlLanguageCustom=e+"strings/strings."+l+"xml",this.urlLanguageDefault=e+"strings/strings.xml",this.resourceDict={},this.dpiList=o,this.browserDpi=s,this.scaleFactor=n;for(var c=this.dpiList.length-1,d=0;d<this.dpiList.length;d++)if(this.dpiList[d]>160*s*n){c=d;break}this.dpi=this.dpiList[c],this.imageScale=160/this.dpi,this.xmlHttpWidget=new XMLHttpRequest,this.xmlHttpWidget.rm=this,this.xmlHttpWidget.onreadystatechange=this.readyEvent,this.xmlHttpWidget.open("GET",this.urlWidget),this.xmlHttpWidget.send(null),this.xmlHttpLanguageCustom=new XMLHttpRequest,this.xmlHttpLanguageCustom.rm=this,this.xmlHttpLanguageCustom.onreadystatechange=this.readyEvent,this.xmlHttpLanguageCustom.open("GET",this.urlLanguageCustom),this.xmlHttpLanguageCustom.send(null),this.xmlHttpLanguageDefault=new XMLHttpRequest,this.xmlHttpLanguageDefault.rm=this,this.xmlHttpLanguageDefault.onreadystatechange=this.readyEvent,this.xmlHttpLanguageDefault.open("GET",this.urlLanguageDefault),this.xmlHttpLanguageDefault.send(null)}readyEvent(e){if(4==e.target.readyState&&200==e.target.status){var t=new DOMParser;e.target.responseURL==e.target.rm.urlWidget?(e.target.rm.widgetLoaded=1,e.target.rm.xmlDoc=t.parseFromString(e.target.responseText,"text/xml")):e.target.responseURL==e.target.rm.urlLanguageCustom?e.target.rm.languageCustomLoaded=1:e.target.responseURL==e.target.rm.urlLanguageDefault&&(e.target.rm.languageDefaultLoaded=1)}else 4==e.target.readyState&&200!=e.target.status&&(e.target.responseURL==e.target.rm.urlWidget?e.target.rm.widgetLoaded=-1:e.target.responseURL==e.target.rm.urlLanguageCustom?e.target.rm.languageCustomLoaded=-1:e.target.responseURL==e.target.rm.urlLanguageDefault&&(e.target.rm.languageDefaultLoaded=-1));if(0!==e.target.rm.widgetLoaded&&(0!==e.target.rm.languageCustomLoaded||0!==e.target.rm.languageDefaultLoaded)){if(-1==e.target.rm.widgetLoaded)e.target.rm.status=-1;else if(1==e.target.rm.languageCustomLoaded){var a=e.target.rm.xmlHttpLanguageCustom.responseText,t=new DOMParser;e.target.rm.xmlLang=t.parseFromString(a,"text/xml"),e.target.rm.status=1}else if(1==e.target.rm.languageDefaultLoaded){var a=e.target.rm.xmlHttpLanguageDefault.responseText,t=new DOMParser;e.target.rm.xmlLang=t.parseFromString(a,"text/xml"),e.target.rm.status=1}else e.target.rm.status=-1;if(1==e.target.rm.status){for(var r,o={},s=e.target.rm.xmlDoc.querySelectorAll("[font]"),n=0;n<s.length;n++)r=s[n].getAttribute("font"),0<r.length&&(o[r]=r);e.target.rm.fontRequestVector=[];var i,l=document.createElement("style");for(i in o){var c=e.target.rm.getResourceUrlBase(o[i]),d=o[i];l.appendChild(document.createTextNode("@font-face { font-family: '"+d+"'; src: url('"+c+"'); }"));var g=new XMLHttpRequest;g.open("GET",c,!0),g.send(),e.target.rm.fontRequestVector.push(g)}document.head.appendChild(l),e.target.rm.eventStatus(e.target.rm.caller,!0)}else e.target.rm.eventStatus(e.target.rm.caller,!1)}}static httpGet(e,t){var a=new XMLHttpRequest;return a.onreadystatechange=t,a.open("GET",e),a.send(null),200==a.status?a.responseText:""}getElement(e,t){if("facephi-widget-conf"==e){var a=this.xmlDoc.getElementsByTagName("facephi-widget-conf");return a[0]}var i=this.xmlDoc.querySelector("[id="+e+"]");if(this.logDebug&&console.log(i),void 0==i)return void console.log("ResourceManager::getElement Error. viewId="+e+" undefined. Please verify resource's bundle.");var r=i.querySelector("[id="+t+"]");return this.logDebug&&console.log(r),void 0==r?void console.log("ResourceManager::getElement Error. elementId="+t+" undefined. Please verify resource's bundle."):r}getSetupColor(e,t,i){var o=this.getElement(e,t),s=o.getAttribute(i);if(9==s.length){var n,r,l,c;n=parseInt(s.substring(1,3),16),r=parseInt(s.substring(3,5),16),l=parseInt(s.substring(5,7),16),c=parseInt(s.substring(7,9),16),c/=255,s="rgba("+n+", "+r+", "+l+", "+c.toFixed(3)+")"}return s}getSetupColorWithAlpha(e,t,a,i){var o,r,s,n=this.getElement(e,t),l=n.getAttribute(a);return o=parseInt(l.substring(1,3),16),r=parseInt(l.substring(3,5),16),s=parseInt(l.substring(5,7),16),l="rgba("+o+", "+r+", "+s+", "+i.toFixed(3)+")",l}getSetupFloat(e,t,a){var i=this.getElement(e,t),r=i.getAttribute(a);return parseFloat(r)}getSetupAlign(e,t,a){var i=this.getElement(e,t);return i.getAttribute(a)}getSetupResourceId(e,t,a){var i,r=this.getElement(e,t),o=r.getAttribute(a),s=o.split(",");return s&&1<s.length?(i=s[Math.floor(Math.random()*s.length)],i=i.trim()):i=o,i}getSetupTextId(e,t,a){var i=this.getElement(e,t);return i.getAttribute(a)}getSetupNodeType(e,t){var a=this.getElement(e,t);return a.getAttribute("content_type")}getResourceUrl(e){return this.baseURL+"resources/"+this.dpi+"dpi/"+e}getResourceUrlBase(e){return this.baseURL+"resources/"+this.dpiList[0]+"dpi/"+e}getImageScale(){return this.imageScale}getImage(e){if(!(e in this.resourceDict)){var t=this.getResourceUrl(e),a=document.createElement("img");a.src=t,this.resourceDict[e]=a}else;return this.resourceDict[e]}translate(e){var t=e,a=this.xmlLang.querySelector("[id="+e+"]");return this.logDebug&&console.log(a),null!=a&&(t=a.textContent),t}}FPhi.UserControlMode={Authenticate:0,Register:1},FPhi.LivenessMode={None:0,Blink:1},FPhi.UserControlState={Off:0,Nothing:1,WaitingFace:2,WaitingFaceStart:3,Extracting:4,Liveness1:5,Liveness2:6,Liveness3:7,InitialTip:8,CycleTip:9,ShowResults:10,Improve:11,ImproveWizard:12,WizardComplete:13,Finish:14,CancelByUser:15,WaitingEyeDetection:16,Errors:17,CamFailed:18,WaitForWasmReady:19},FPhi.UserControlStateInv={0:"Off",1:"Nothing",2:"WaitingFace",3:"WaitingFaceStart",4:"Extracting",5:"Liveness1",6:"Liveness2",7:"Liveness3",8:"InitialTip",9:"CycleTip",10:"ShowResults",11:"Improve",12:"ImproveWizard",13:"WizardComplete",14:"Finish",15:"CancelByUser",16:"UCWaitingEyeDetection",17:"Errors",18:"CamFailed",19:"WaitForWasmReady"},FPhi.ExceptionType={CameraError:0,ExtractorError:1,ControlNotInitializedError:2,ImageCropResizeError:3,UnexpectedCaptureError:4},FPhi.ImageFormat={None:0,Gray_8bpp:1,RGB_24bpp:2,BGR_24bpp:3,ARGB_32bpp:4,YUV_NV21:5,ABGR_32bpp:6,BGRA_32bpp:7,RGBA_32bpp:8},FPhi.SampleDiagnostic={Ok:0,FaceNotFound:1,RightEyeNotFound:2,LeftEyeNotFound:3,EyesNotFound:4,FaceTooFar:5,FaceTooClose:6,TooCloseToWindowSide:7,AngleExceeded:8,QualityCheckFailed:9,NotRated:10},FPhi.FinalDiagnostic={InsufficientValidSamples:0,TemplateCreationInProgress:1,TemplateCreated:2},FPhi.LivenessDiagnostic={NotRated:0,PhotoDetected:1,LivenessDetected:2,Unsuccess:3,UnsuccessLowPerformance:4,UnsuccessGlasses:5,UnsuccessLight:6},FPhi.UserControl=function(e,t,a,i,r,o,s,n,l,c,d,g,u,m,h){this.divContainer=document.getElementById(e);var v=this.getScriptPath("FPhi.UC.wasm.js");this.wasmReady=!1,this.worker=new Worker(v+"FPhi.UC.worker.wasm.js"),this.worker.onmessage=this.handleExtractorMessage.bind(this),this.worker.widget=this,this.queuedCommands=0,this.language=d,this.cameraWidth=t,this.cameraHeight=a,this.canvasWidth=500,this.canvasHeight=500,void 0!=m&&(this.canvasWidth=m),void 0!=h&&(this.canvasHeight=h),this.fontSizeFactor=this.canvasHeight/500,this.canvasSizeFactor=this.canvasHeight/500,this.buttonHeight*=this.canvasSizeFactor,this.fpsTime=performance.now(),this.baseURL=g,this.rm=new ResourceManager(g,this.language,this,this.OnResourceManagerStatus,u,window.devicePixelRatio,this.canvasSizeFactor),this.divContainer.addEventListener("FPhi.UserControl.Finish.event",i,!0),this.divContainer.addEventListener("FPhi.UserControl.UserCancel.event",r,!0),this.divContainer.addEventListener("FPhi.UserControl.ExtractionTimeout.event",s,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessError.event",n,!0),this.divContainer.addEventListener("FPhi.UserControl.LivenessErrorButtonClick.event",l,!0),this.divContainer.addEventListener("FPhi.UserControl.TimeoutErrorButtonClick.event",c,!0),this.divContainer.addEventListener("FPhi.UserControl.ExceptionCaptured.event",o,!0),this.imageTimeout=document.createElement("img"),this.imageTimeout.src=v+FPhi.UserControl.Images.timeOutUrl,this.imageError=document.createElement("img"),this.imageError.src=v+FPhi.UserControl.Images.livenessErrorUrl,this.imageLiveness=document.createElement("img"),this.imageLiveness.src=v+FPhi.UserControl.Images.livenessErrorUrl,this.imageLivenessGlasses=document.createElement("img"),this.imageLivenessGlasses.src=v+FPhi.UserControl.Images.livenessGlassesUrl,this.imageLivenessLight=document.createElement("img"),this.imageLivenessLight.src=v+FPhi.UserControl.Images.livenessLightsUrl,this.imageLivenessPerformance=document.createElement("img"),this.imageLivenessPerformance.src=v+FPhi.UserControl.Images.livenessPerformanceUrl,this.imageCamera=document.createElement("img"),this.imageCamera.src=v+FPhi.UserControl.Images.noCamerasUrl,this.cameraContainer=document.createElement("div"),this.divContainer.appendChild(this.cameraContainer);var p=document.getElementById("gifWaiting");if(p&&(p.style.display="none"),0>=this.cropFactor){var f=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Invalid value of CropFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(f),this.cropFactor=1}if(0>=this.resizeFactor){var f=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Invalid value of ResizeFactor. Must be greather than 0.",exceptionType:3}});this.divContainer.dispatchEvent(f),this.resizeFactor=1}return 0>=this.sceneTimeout?void(this.sceneTimeout=0):void 0},FPhi.UserControl.Language={en:{faceNotDetected:"Face not detected",livenessError:"Please, remain still and blink next time",livenessErrorGlasses:"If you are wearing glasses,\navoid the reflections next time",livenessErrorDark:"Look for an illuminated place\nwith no backlighting next time",livenessErrorPerformance:"Your pc performance is lower\nthan expected",timeout:"Information: Maximum time allowed exceeded"},es:{faceNotDetected:"Cara no detectada",livenessError:"Permanece quieto y parpadea\ncuando accedas la pr\xF3xima vez",livenessErrorGlasses:"Si llevas gafas, evita los reflejos\ncuando accedas la pr\xF3xima vez",livenessErrorDark:"Busca un lugar iluminado y sin contraluces\ncuando accedas la pr\xF3xima vez",livenessErrorPerformance:"El funcionamiento de su PC\nes m\xE1s lento de lo esperado",timeout:"Has excedido el tiempo permitido"}},FPhi.UserControl.Color={leftButtonColor:"rgba(16,163,199,1)",rightButtonColor:"rgba(164,164,164,1)",leftButtonTextColor:"rgba(255,255,255,1)",rightButtonTextColor:"rgba(255,255,255,1)",redColor:"rgba(255,0,0,1)",blueColor:"rgba(16,163,199,1)",greenColor:"rgba(63,183,109,1)",orangeColor:"rgba(240, 154, 71, 1)",blackColor:"rgba(0,0,0,1)",whiteColor:"rgba(255,255,255,1)",grayColor:"rgba(255,255,255,0.7)",grayColor2:"rgba(0,0,0,0.7)",grayColor3:"rgba(127,125,125,1)",grayColor4:"rgba(127,127,127,0.3)",blindColor:"rgba(16,163,199,0.5)"},FPhi.UserControl.Images={timeOutUrl:"../FPhi.UC.Resources/Images/timeout.png",livenessErrorUrl:"../FPhi.UC.Resources/Images/livenessError.png",livenessGlassesUrl:"../FPhi.UC.Resources/Images/livenessGlasses.png",livenessLightsUrl:"../FPhi.UC.Resources/Images/livenessLights.png",livenessPerformanceUrl:"../FPhi.UC.Resources/Images/livenessPerformance.png",noCamerasUrl:"../FPhi.UC.Resources/Images/errorNoCams.png"},FPhi.UserControl.prototype={constructor:FPhi.UserControl,extractionMode:FPhi.UserControlMode.Authenticate,livenessMode:FPhi.LivenessMode.None,status:FPhi.UserControlState.Off,language:"es",userTags:null,privateCanvas:null,extractor:null,extractorLiveness:null,extractorVersion:"",livenessTimer:null,lastDetectResult:null,lastExtractionResult:null,lastExtractionResultWizard:null,faceAvailable:!0,faceDataRect:null,faceAvailableDelayed:!0,faceTooFar:!1,bestScore:0,actualTime:0,actualTimePrev:0,clockWaitingFace:null,clockWaitingStart:null,clockExtraction:null,clockExtractionPure:null,clockCycleTip:null,clockWizardCompleted:null,clockShowResults:null,clockImprove:null,clockLiveness1:null,clockLiveness2:null,clockLiveness3:null,clockLiveness3_finish:null,clockFinish:null,clockNewScenario:null,clockWarningIn:null,clockWarningOut:null,clockEyeDetection:null,clockEyeDetectionDetected:null,waitingTimeStart:3,extractionTime:5,extractionTimePartial:0,extractionSmartMinScore:.5,liveness1Time:.5,liveness3Time:.25,livenessActualRetrain:0,livenessCalculating:!1,livenessErrorString:"",livenessErrorImage:null,showImproveButton:!1,maxResults:15,graphicalScoreMax:0,privateLastImage:null,privateImages:[],privateLivenessImages:[],privateLivenessImageTemp:null,privateLivenessTimerDiagnostic:null,privateLivenessResults:[],privateEyesYLevel:0,divContainer:null,extractorContainer:null,cameraContainer:null,cameraWidth:null,cameraHeight:null,canvasWidth:null,canvasHeight:null,cameraStream:null,selectedSource:null,samplePeriod:1e3/60,buttonHeight:50,debug:!1,fps:0,fpse:0,fpsframes:0,fpseFrames:0,fpsTime:null,fontSizeFactor:1,canvasSizeFactor:1,imageTips1:null,imageTips2:null,imageFaceMoving:[],imageCheck:null,imageError:null,imageArrow:null,imageLiveness:null,imageLivenessGlasses:null,imageLivenessLight:null,imageLivenessPerformance:null,imageTimeout:null,imageCamera:null,cropImage:!0,cropFactor:1,resizeFactor:1,warningInTime:.8,warningOutTime:0,detectionTimeout:1e4,extractionTimeout:2e4,sceneTimeout:0,sendingTimeout:2,Start:function(){this.selectedSource=null,this.initCamera(this.cameraContainer,this.cameraWidth,this.cameraHeight),this.setVideoInput(this),this.setStatus(this,FPhi.UserControlState.Nothing)},Stop:function(){null!=this.cameraStream&&this.cameraStream.getVideoTracks()[0].stop(),this.setStatus(this,FPhi.UserControlState.Off)},postMessage:function(e,t){e.queuedCommands++,e.worker.postMessage(t)},setLastExtractionResult:function(e,t){null!=e.lastExtractionResult&&e.lastExtractionResult.delete(),e.lastExtractionResult=t},setStatus:function(e,t){switch(this.status=t,t){case FPhi.UserControlState.WizardComplete:e.clockWizardCompleted=performance.now(),e.videoPlayer.loop=!1,e.videoPlayer.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId("Success","video_success","value")),e.videoPlayer.play();break;case FPhi.UserControlState.InitialTip:e.videoPlayer.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId("RegistrationTips","tip_video","value")),e.videoPlayer.play(),e.clockNewScenario=performance.now();break;case FPhi.UserControlState.Nothing:e.lastExtractionResult=null,e.bestScore=0,e.faceAvailable=!1,e.clockWaitingStart=null,e.clockExtraction=null,e.clockExtractionPure=null,e.clockLiveness=null,e.extractionTime=e.extractionMode==FPhi.UserControlMode.Register?7:1,e.livenessCalculating=!1,e.privateLastImage=null,e.privateImages=[],e.privateLivenessImages=[],e.privateLivenessResults=[],e.livenessActualRetrain=0,e.livenessErrorString=null;break;case FPhi.UserControlState.WaitingFace:e.clockWaitingFace=performance.now(),e.clockNewScenario=performance.now();case FPhi.UserControlState.WaitingFaceStart:e.clockNewScenario=performance.now(),e.videoPlayer.pause(),e.postMessage(e,{cmd:"livenessTimerSetValues",timeLapse:700,fps:10}),e.postMessage(e,{cmd:"livenessTimerReset"});break;case FPhi.UserControlState.Extracting:e.clockNewScenario=performance.now(),e.clockExtraction=performance.now(),e.clockExtractionPure=e.clockExtraction,e.extractionTimePartial=0,e.extractionMode==FPhi.UserControlMode.Register&&(e.videoPlayer.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId("Extractor","extraction_video","value")),e.videoPlayer.play()),e.postMessage(e,{cmd:"initStreamExtraction",extractionMode:e.extractionMode,livenessMode:e.livenessMode,userTags:e.userTags});break;case FPhi.UserControlState.CycleTip:e.videoPlayer.src=e.rm.getResourceUrlBase(e.rm.getSetupResourceId("FaceMovementTips","tip_video","value")),e.videoPlayer.play(),e.clockCycleTip=performance.now(),e.clockNewScenario=performance.now();break;case FPhi.UserControlState.Finish:e.clockFinish=performance.now();for(var i=[],r=0;r<e.privateImages.length;r++)i.push(e.getImgTag(e.privateImages[r],e.cropImage,e.cropFactor,e.resizeFactor));var a=new CustomEvent("FPhi.UserControl.Finish.event",{detail:{template:e.lastExtractionResult.template,images:i}});this.divContainer.dispatchEvent(a);break;case FPhi.UserControlState.CancelByUser:e.Stop();var a=new CustomEvent("FPhi.UserControl.UserCancel.event");return void this.divContainer.dispatchEvent(a);case FPhi.UserControlState.ShowResults:e.videoPlayer.pause(),e.clockNewScenario=performance.now(),e.clockShowResults=performance.now(),null!=e.lastExtractionResultWizard&&(e.setLastExtractionResult(e.lastExtractionResultWizard),e.lastExtractionResultWizard=null);break;case FPhi.UserControlState.Liveness1:e.clockLiveness1=performance.now();break;case FPhi.UserControlState.Liveness2:e.clockLiveness2=performance.now(),e.privateLivenessImages=[],e.postMessage(e,{cmd:"livenessTimerReset"});break;case FPhi.UserControlState.Liveness3:e.clockLiveness3_finish=null,e.clockLiveness3=performance.now(),e.postMessage(e,{cmd:"evaluateLiveness",images:e.privateLivenessImages,template:e.lastExtractionResult.Template});break;case FPhi.UserControlState.WaitingEyeDetection:e.clockNewScenario=performance.now(),e.clockEyeDetection=performance.now(),e.clockEyeDetectionDetected=null;break;case FPhi.UserControlState.Errors:if(e.livenessErrorImage==e.imageLiveness){e.clockNewScenario=performance.now();var a=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:{livenessErrorType:0}});e.divContainer.dispatchEvent(a)}else if(e.livenessErrorImage==e.imageLivenessGlasses){e.clockNewScenario=performance.now();var a=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:{livenessErrorType:1}});e.divContainer.dispatchEvent(a)}else if(e.livenessErrorImage==e.imageLivenessLight){e.clockNewScenario=performance.now();var a=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:{livenessErrorType:2}});e.divContainer.dispatchEvent(a)}else if(e.livenessErrorImage==e.imageLivenessPerformance){e.clockNewScenario=performance.now();var a=new CustomEvent("FPhi.UserControl.LivenessError.event",{detail:{livenessErrorType:3}});e.divContainer.dispatchEvent(a)}else e.divContainer.dispatchEvent(new CustomEvent("FPhi.UserControl.ExtractionTimeout.event"));}},getImageData:function(e){var t=e.getContext("2d"),a=e.height,i=e.width,r=t.getImageData(0,0,i,a),o={width:i,height:a,pixels:r,time:performance.now()};return o},getImgTag:function(e,t,a,i){var r=document.createElement("canvas");r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e.pixels,0,0);var o=document.createElement("canvas");if(t){var s=e.extractionResult.face.width*a,n=e.extractionResult.face.height*a,l=e.extractionResult.face.x-(a-1)*e.extractionResult.face.width/2,c=e.extractionResult.face.y-(a-1)*e.extractionResult.face.height/2;0>l&&(s+=l,l=0),0>c&&(n+=c,c=0),l+s>=e.width&&(s=e.width-l),c+n>=e.height&&(n=e.height-c),o.width=s,o.height=n,o.getContext("2d").drawImage(r,l,c,s,n,0,0,o.width,o.height)}else o.width=e.width*i,o.height=e.height*i,o.getContext("2d").drawImage(r,0,0,o.width,o.height);var d=document.createElement("img");return d.src=o.toDataURL("image/jpeg"),d},handleExtractorMessage:function(e){this.fpseframes++;var t=this.faceAvailable;if(this.queuedCommands--,"ready"==e.data.cmd)this.queuedCommands++,this.wasmReady=!0;else if("detect"==e.data.cmd){this.lastDetectResult=e.data,this.faceAvailable=!1;var a=this.lastDetectResult;if(a.sampleDiagnostic==FPhi.SampleDiagnostic.Ok){if(a.face){var i=this.fromCameraToScreenDetection(this,a.face);this.faceInsideCircle(this,i)&&(this.faceAvailable=!0,this.faceDataRect=i)}if(a.leftEye){var i=this.fromCameraToScreenDetection(this,{x:a.leftEye.x,y:a.leftEye.y,width:1,height:1});this.privateEyesYLevel=i.y}}this.faceTooFar=a.sampleDiagnostic==FPhi.SampleDiagnostic.FaceTooFar,this.status==FPhi.UserControlState.WaitingEyeDetection&&this.faceAvailable&&null==this.clockEyeDetectionDetected&&(this.clockEyeDetectionDetected=performance.now())}else if("extractNextSmart"==e.data.cmd){if(this.lastExtractionResult=e.data,this.faceTooFar=e.data.sampleDiagnostic==FPhi.SampleDiagnostic.FaceTooFar,this.faceAvailable=!1,e.data.sampleDiagnostic==FPhi.SampleDiagnostic.Ok){var i=this.fromCameraToScreenDetection(this,this.lastExtractionResult.face);this.faceInsideCircle(this,i)&&(this.faceAvailable=!0,this.faceDataRect=i)}if(this.lastExtractionResult.leftEye){var i=this.fromCameraToScreenDetection(this,{x:this.lastExtractionResult.leftEye.x,y:this.lastExtractionResult.leftEye.y,width:1,height:1});this.privateEyesYLevel=i.y}if((this.status==FPhi.UserControlState.Extracting||this.status==FPhi.UserControlState.Improve)&&(this.privateLastImage.extractionResult=this.lastExtractionResult,this.lastExtractionResult.sampleDiagnostic==FPhi.SampleDiagnostic.Ok&&!0==this.faceAvailable)){this.lastExtractionResult.facialScore;15>this.privateImages.length?this.privateImages.push(this.privateLastImage):this.privateImages=this.distAlgSustitution(this,this.privateImages,this.privateLastImage)}}else if("evaluateLiveness"==e.data.cmd){if(e.data.livenessDiagnostic==FPhi.LivenessDiagnostic.LivenessDetected)this.setStatus(this,FPhi.UserControlState.Finish);else if(this.livenessActualRetrain+=e.data.penalty,3<=this.livenessActualRetrain){switch(this.livenessErrorString=this.translate(this,"faceNotDetected"),e.data.livenessDiagnostic){case FPhi.LivenessDiagnostic.Unsuccess:this.livenessErrorString=this.translate(this,"livenessError"),this.livenessErrorImage=this.imageLiveness;break;case FPhi.LivenessDiagnostic.UnsuccessGlasses:this.livenessErrorString=this.translate(this,"livenessErrorGlasses"),this.livenessErrorImage=this.imageLivenessGlasses;break;case FPhi.LivenessDiagnostic.UnsuccessLight:this.livenessErrorString=this.translate(this,"livenessErrorDark"),this.livenessErrorImage=this.imageLivenessLight;break;case FPhi.LivenessDiagnostic.UnsuccessLowPerformance:this.livenessErrorString=this.translate(this,"livenessErrorPerformance"),this.livenessErrorImage=this.imageLivenessPerformance;}this.setStatus(this,FPhi.UserControlState.Errors)}else this.clockLiveness3_finish=this.actualTime;}else if("livenessTimerReset"==e.data.cmd);else if("livenessTimerSetValues"==e.data.cmd);else"livenessTimerAdd"==e.data.cmd&&(!0==e.data.status&&this.privateLivenessImages.push(this.privateLivenessImageTemp),!0==e.data.isFull&&(this.privateLivenessTimerDiagnostic=e.data.livenessTimerDiagnostic,this.setStatus(this,FPhi.UserControlState.Liveness3)));this.faceTooFar&&(this.faceAvailable=!1),!0==t&&!1==this.faceAvailable?this.clockWarningIn=this.actualTime:!1==t&&!0==this.faceAvailable?this.clockWarningOut=this.actualTime:this.faceAvailable&&this.actualTime-this.clockWarningOut>1e3*this.warningOutTime?this.faceAvailableDelayed=this.faceAvailable:!this.faceAvailable&&this.actualTime-this.clockWarningIn>1e3*this.warningInTime&&(this.faceAvailableDelayed=this.faceAvailable)},canvasOnMove:function(t){if(t.target.style.cursor="default",this.status!=FPhi.UserControlState.Off){var e=t.offsetX,a=t.offsetY,i=this.canvasHeight-this.buttonHeight;if(a>i)(this.status==FPhi.UserControlState.InitialTip||this.status==FPhi.UserControlState.CycleTip||this.status==FPhi.UserControlState.WaitingFaceStart||this.status==FPhi.UserControlState.ShowResults)&&(e<this.canvasWidth/2?t.target.style.cursor="pointer":t.target.style.cursor="pointer");else{var r=this.rm.getSetupResourceId("RegistrationTips","button_exit","value"),o=this.rm.getImage(r),s=this.canvasSizeFactor*this.rm.getImageScale(),n=15;a<2*n+o.height*s&&e>this.canvasWidth-2*n-o.height*s?t.target.style.cursor="pointer":a<2*n+o.height*s&&e<2*n+o.height*s&&this.status==FPhi.UserControlState.WaitingFaceStart&&this.extractionMode==FPhi.UserControlMode.Register?t.target.style.cursor="pointer":a>.701*this.canvasHeight&&a<=.805*this.canvasHeight&&e>this.canvasWidth/2-75&&e<=this.canvasWidth/2+75&&this.showImproveButton&&this.status==FPhi.UserControlState.ShowResults&&(t.target.style.cursor="pointer")}}},canvasOnClick:function(t){if(this.status!=FPhi.UserControlState.Off){var e=t.offsetX,a=t.offsetY,i=this.canvasHeight-this.buttonHeight;if(!(a>i)){var r=this.rm.getSetupResourceId("RegistrationTips","button_exit","value"),o=this.rm.getImage(r),s=this.canvasSizeFactor*this.rm.getImageScale(),n=15;a<2*n+o.height*s&&e>this.canvasWidth-2*n-o.height*s?this.setStatus(this,FPhi.UserControlState.CancelByUser):a<2*n+o.height*s&&e<2*n+o.height*s&&this.status==FPhi.UserControlState.WaitingFaceStart&&this.extractionMode==FPhi.UserControlMode.Register?this.setStatus(this,FPhi.UserControlState.InitialTip):a>.701*this.canvasHeight&&a<=.805*this.canvasHeight&&e>this.canvasWidth/2-75&&e<=this.canvasWidth/2+75&&this.showImproveButton&&this.status==FPhi.UserControlState.ShowResults&&this.setStatus(this,FPhi.UserControlState.ImproveWizard)}else if(e<this.canvasWidth/2)switch(this.status){case FPhi.UserControlState.Errors:var l;this.livenessErrorString==this.translate(this,"timeout")?(l=new CustomEvent("FPhi.UserControl.TimeoutErrorButtonClick.event"),this.divContainer.dispatchEvent(l),this.Stop()):(l=new CustomEvent("FPhi.UserControl.LivenessErrorButtonClick.event"),this.divContainer.dispatchEvent(l),this.Stop());break;case FPhi.UserControlState.InitialTip:this.setStatus(this,FPhi.UserControlState.WaitingFaceStart);break;case FPhi.UserControlState.CycleTip:this.setStatus(this,FPhi.UserControlState.InitialTip);break;case FPhi.UserControlState.WaitingFaceStart:this.setStatus(this,FPhi.UserControlState.Extracting);break;case FPhi.UserControlState.ShowResults:var c=this.getGraphicalScore(this.lastExtractionResult.templateScore);1>c?this.setStatus(this,FPhi.UserControlState.WaitingFaceStart):this.setStatus(this,FPhi.UserControlState.WizardComplete);}else switch(this.status){case FPhi.UserControlState.InitialTip:this.setStatus(this,FPhi.UserControlState.CycleTip);break;case FPhi.UserControlState.CycleTip:this.setStatus(this,FPhi.UserControlState.WaitingFaceStart);break;case FPhi.UserControlState.WaitingFace:case FPhi.UserControlState.WaitingFaceStart:this.setStatus(this,FPhi.UserControlState.Extracting);break;case FPhi.UserControlState.ShowResults:this.setStatus(this,FPhi.UserControlState.WizardComplete);break;case FPhi.UserControlState.Errors:var l;this.livenessErrorString==this.translate(this,"timeout")?(l=new CustomEvent("FPhi.UserControl.TimeoutErrorButtonClick.event"),this.divContainer.dispatchEvent(l),this.Stop()):(l=new CustomEvent("FPhi.UserControl.LivenessErrorButtonClick.event"),this.divContainer.dispatchEvent(l),this.Stop());}}},initCamera:function(e,t,a){if(-1<!e.innerHTML.indexOf("video")){var i="<video id='live' width='auto' height='auto' hidden muted playsinline autoplay></video><video id='fphiVideoPlayer' hidden playsinline loop muted autoplay></video><canvas id='display' width='"+this.canvasWidth+"' height='"+this.canvasHeight+"'></canvas>";e.innerHTML=i,this.videoPlayer=document.getElementById("fphiVideoPlayer")}var r=document.getElementById("display"),o=r.clientWidth,s=r.clientHeight;this.circleX=o/2,this.circleY=.38*s,this.circleRadius=.31*s,r&&(r.style.display="inline-block",r.addEventListener("click",this.canvasOnClick.bind(this),!1),r.addEventListener("mousemove",this.canvasOnMove.bind(this),!1),this.privateCanvas=document.createElement("canvas"),this.privateCanvas.height=a,this.privateCanvas.width=t)},userMedia:function(){return navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||null},setVideoInput:function(e){var t=document.getElementById("live"),a=document.getElementById("display");if(a){var i=a.getContext("2d",{alpha:!1});if(e.userMedia())var r={video:{width:e.cameraWidth,height:e.cameraHeight},audio:!1},o=navigator.mediaDevices.getUserMedia(r).then(function(a){e.cameraStream=a,t.srcObject=a,t.addEventListener("loadedmetadata",e.videoLoaded.bind(e),!1),t.play(),e.draw(e,t,i)}).catch(function(){console.log("camera error"),e.setStatus(this,FPhi.UserControlState.CamFailed),e.draw(e,e.imageCamera,i);var t=new CustomEvent("FPhi.UserControl.ExceptionCaptured.event",{detail:{message:"Camera not found.",exceptionType:0}});e.divContainer.dispatchEvent(t)})}},fromCameraToScreen:function(e,t){var a=e.scaleRect({width:e.cameraWidth,height:e.cameraHeight},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),i=a.width/e.cameraWidth,r=a.height/e.cameraHeight,o={x:t.x*i,y:t.y*r,width:t.width*i,height:t.height*r},s=e.reflectedX(a.width,o.x+o.width);return o.x=s,o.x+=a.x,o.y+=a.y,o},fromCameraToScreenDetection:function(e,t){var a=e.scaleRect({width:e.cameraWidth,height:e.cameraHeight},{x:0,y:0,width:e.canvasWidth,height:e.canvasHeight}),i=a.width/e.cameraWidth,r=a.height/e.cameraHeight,o={x:t.x*i,y:t.y*r,width:t.width*i,height:t.height*r},s=e.reflectedX(a.width,o.x+o.width);return o.x=s,o.x+=a.x,o.y+=a.y,o},faceInsideCircle:function(e,t){var a=Math.max,i=Math.min,r=e.circleRadius,o=e.circleX,s=e.circleY,n={x:t.x,y:t.y,width:t.width,height:t.height},l=a(0,i(n.x+n.width,o+r)-a(n.x,o-r))*a(0,i(n.y+n.height,s+r)-a(n.y,s-r)),c=n.width*n.height;return!!(.75<l/c)},scaleRect:function(e,t,a){var i=t.x+t.width/2,r=t.y+t.height/2,o=t.width/e.width,s=t.height/e.height,n=e.width*o,l=e.height*o;return void 0==a?l<t.height&&(n=e.width*s,l=e.height*s):l>=t.height&&(n=e.width*s,l=e.height*s),{x:i-n/2,y:r-l/2,width:n,height:l}},scaleRectByFactor(e,t,a){var i=e.x+.5*e.width,r=e.y+.5*e.height,o={x:0,y:0,width:0,height:0};o.width=e.width*=t,o.height=e.height*=a,o.x=e.x,o.y=e.y;var s=e.x+.5*e.width,n=e.y+.5*e.height;return o.x-=s-i,o.y-=n-r,o},getGraphicalScore:function(e){"undefined"==typeof e&&(e=0);var t=.9*(100*e/90*(100*e/90))+.1;return 1<t&&(t=1),t},drawButtonClose:function(e,t,a){var i=t.canvas.clientWidth,r=e.rm.getSetupResourceId(a,"button_exit","value"),o=e.rm.getImage(r),s=e.canvasSizeFactor*e.rm.getImageScale(),n=15;t.drawImage(o,i-o.width*s-n,n,o.width*s,o.height*s)},drawButtonInfo:function(e,t,a){var i=t.canvas.clientWidth,r=e.rm.getSetupResourceId(a,"button_info","value"),o=e.rm.getImage(r),s=e.canvasSizeFactor*e.rm.getImageScale(),n=15;t.drawImage(o,n,n,o.width*s,o.height*s)},drawButton:function(e,t,a,i,r){t.fillStyle=e.rm.getSetupColor(i,r,"decorator"),t.fillRect(a.x,a.y+4,a.width,a.height-4),t.fillStyle=e.rm.getSetupColor(i,r,"background"),t.fillRect(a.x,a.y,a.width,a.height-4);var o=e.rm.getSetupAlign(i,r,"align"),s=e.rm.getSetupNodeType(i,r),n=10*e.canvasSizeFactor;if("TEXT_ID"==s){var l=e.rm.getSetupTextId(i,r,"content"),c=e.rm.translate(l),d=e.rm.getSetupFloat(i,r,"font_size");d=Math.round(d*e.fontSizeFactor);var g=e.rm.getSetupResourceId(i,r,"font");t.font=d+"px '"+g+"'",t.fillStyle=e.rm.getSetupColor(i,r,"foreground");var u=t.measureText(c);"LEFT"==o?t.fillText(c,a.x+n,a.y+a.height/2+d/2):"RIGHT"==o?t.fillText(c,a.x+a.width-u.width-n,a.y+a.height/2+d/2):t.fillText(c,a.x+a.width/2-u.width/2,a.y+a.height/2+d/2)}else{var l=e.rm.getSetupResourceId(i,r,"content"),m=e.rm.getImage(l),h=e.canvasSizeFactor*e.rm.getImageScale();"LEFT"==o?t.drawImage(m,a.x+n,a.y+a.height/2-m.height*h/2,m.width*h,m.height*h):"RIGHT"==o?t.drawImage(m,a.x+a.width-m.width*h-n,a.y+a.height/2-m.height*h/2,m.width*h,m.height*h):t.drawImage(m,a.x+a.width/2-m.width*h/2,a.y+a.height/2-m.height*h/2,m.width*h,m.height*h)}},drawBlind:function(e,t,a,i,r,o,s,n,l){var c=t.canvas.clientWidth,d=t.canvas.clientHeight,g=.5*((o-i)/r)+.5,u=2*r*(1-g);t.save(),t.beginPath(),t.arc(a,i,r,0,2*Math.PI,!1),t.clip(),t.fillStyle=n,t.fillRect(a-r,i-r,2*r,2*r*g*s),t.fillRect(a-r,i+r-u+u*(1-s),2*r,u*s),t.restore();var m=e.rm.getSetupResourceId("facephi-widget-conf","","font_shutter_text");t.fillStyle=e.rm.getSetupColor("facephi-widget-conf","","color_shutter_text"),t.font=26*e.fontSizeFactor+"px '"+m+"'",dim=t.measureText(l),t.fillText(l,a-dim.width/2,i+r-u+u*(1-s)+30)},showWarningMessage:function(e,t,a,i){var r=t.canvas.clientWidth,o=e.rm.getSetupResourceId("facephi-widget-conf","","font_warning_message");t.font=24*e.fontSizeFactor+"px '"+o+"'",t.fillStyle=i;var s=t.measureText(a);t.fillText(a,r/2-s.width/2,.81*e.canvasHeight)},drawBackground:function(e,t,a){t.fillStyle=e.rm.getSetupColor(a,"background","top"),t.fillRect(0,0,e.canvasWidth,e.circleY-e.circleRadius+1),t.fillStyle=e.rm.getSetupColor(a,"background","middle_top"),t.fillRect(0,e.circleY-e.circleRadius,e.canvasWidth,e.circleY+e.circleRadius+1),t.fillStyle=e.rm.getSetupColor(a,"background","middle_bottom"),t.fillRect(0,e.circleY+e.circleRadius,e.canvasWidth,e.canvasHeight-e.buttonHeight-(e.circleY+e.circleRadius)+1),t.fillStyle=e.rm.getSetupColor(a,"background","bottom"),t.fillRect(0,e.canvasHeight-e.buttonHeight,e.canvasWidth,e.buttonHeight)},draw:function(e,t,a){var r=Math.PI,o=a.canvas.clientWidth,s=a.canvas.clientHeight;e.fpsframes++,e.actualTimePrev=e.actualTime,e.actualTime=performance.now();var n=(e.actualTime-e.fpsTime)/1e3;switch(1<n&&(e.fps=e.fpsframes/n,e.fpse=0<e.fpseframes?e.fpseframes/n:0,e.fpsTime=e.actualTime,e.fpsframes=0,e.fpseframes=0),e.status){case FPhi.UserControlState.WaitingFace:case FPhi.UserControlState.WaitingFaceStart:e.drawBackground(e,a,"StartExtractor");break;case FPhi.UserControlState.Extracting:case FPhi.UserControlState.Improve:case FPhi.UserControlState.Liveness1:case FPhi.UserControlState.Liveness2:case FPhi.UserControlState.Liveness3:case FPhi.UserControlState.WaitingEyeDetection:e.drawBackground(e,a,"Extractor");}switch(e.status){case FPhi.UserControlState.WaitingFace:case FPhi.UserControlState.WaitingFaceStart:case FPhi.UserControlState.Extracting:case FPhi.UserControlState.Improve:case FPhi.UserControlState.Liveness1:case FPhi.UserControlState.Liveness2:case FPhi.UserControlState.Liveness3:case FPhi.UserControlState.WaitingEyeDetection:a.save(),a.beginPath(),a.arc(e.circleX,e.circleY,e.circleRadius,0,2*r,!1),a.clip();break;case FPhi.UserControlState.CamFailed:var l=e.scaleRect({width:o,height:s},{x:0,y:0,width:o,height:s});return a.drawImage(t,l.x,l.y,l.width,l.height),void a.restore();}a.save(),a.translate(o,0),a.scale(-1,1);var l=e.scaleRect({width:e.cameraWidth,height:e.cameraHeight},{x:0,y:0,width:o,height:s});switch(a.drawImage(t,l.x,l.y,l.width,l.height),a.restore(),e.privateCanvas.getContext("2d").drawImage(t,0,0,e.cameraWidth,e.cameraHeight),e.status){case FPhi.UserControlState.WaitingFace:case FPhi.UserControlState.WaitingFaceStart:case FPhi.UserControlState.Extracting:case FPhi.UserControlState.Improve:case FPhi.UserControlState.Liveness1:case FPhi.UserControlState.Liveness2:case FPhi.UserControlState.Liveness3:case FPhi.UserControlState.WaitingEyeDetection:a.restore();}switch(e.iterateAutomata(e,t,a),a.save(),e.status){case FPhi.UserControlState.WaitForWasmReady:case FPhi.UserControlState.Nothing:if(a.fillStyle="#ffffff",a.fillRect(0,0,o,s),-1==e.rm.status){var c=e.rm.getSetupColor("facephi-widget-conf","","color_warning_message");e.showWarningMessage(e,a,"Resources not loaded. Check browser console",c)}break;case FPhi.UserControlState.Finish:var d=e.actualTime-e.clockFinish;d/=1e3,a.fillStyle=FPhi.UserControl.Color.grayColor2,a.fillRect(0,0,o,s);var g=-r/2+r*d,u=-r/2+2*r*d;a.beginPath(),a.strokeStyle=FPhi.UserControl.Color.blueColor,a.lineWidth=3,a.arc(e.circleX,e.circleY,e.circleRadius/2,g,g+r/2),a.stroke(),a.beginPath(),a.strokeStyle=FPhi.UserControl.Color.blueColor,a.lineWidth=2,a.arc(e.circleX,e.circleY,e.circleRadius/3,u,u+r/2),a.stroke();break;case FPhi.UserControlState.WaitingFace:var m=e.rm.getSetupColor("facephi-widget-conf","","color_progress_bar");if(!e.faceAvailableDelayed){var h=e.rm.translate("error_message_face");e.faceTooFar&&(h=e.rm.translate("error_message_closer"));var c=e.rm.getSetupColor("facephi-widget-conf","","color_warning_message");e.showWarningMessage(e,a,h,c),m=c}a.beginPath(),a.strokeStyle=m,a.lineWidth=3,a.arc(e.circleX,e.circleY,e.circleRadius,0,2*r),a.stroke(),e.drawButton(e,a,{x:0,y:s-e.buttonHeight,width:o/2,height:e.buttonHeight},e.translate(e,"cancel"),FPhi.UserControl.Color.leftButtonColor,FPhi.UserControl.Color.leftButtonTextColor),e.drawButton(e,a,{x:o/2,y:s-e.buttonHeight,width:o/2,height:e.buttonHeight},e.translate(e,"start"),FPhi.UserControl.Color.rightButtonColor,FPhi.UserControl.Color.rightButtonTextColor);break;case FPhi.UserControlState.Liveness1:var d=e.actualTime-e.clockLiveness1;d/=1e3*e.liveness1Time,1<d&&(d=1),d=(d-1)*(d-1)*(d-1)+1;var m=e.rm.getSetupColor("facephi-widget-conf","","color_progress_bar");a.beginPath(),a.strokeStyle=m,a.lineWidth=e.rm.getSetupFloat("facephi-widget-conf","","width_progress_bar")*(1-d),a.arc(e.circleX,e.circleY,e.circleRadius-a.lineWidth/2+.5,-r/2,2*r),a.stroke(),e.drawBlind(e,a,e.circleX,e.circleY,e.circleRadius,e.privateEyesYLevel,.8*d,FPhi.UserControl.Color.blindColor,""),e.drawButtonClose(e,a,"Extractor");break;case FPhi.UserControlState.Liveness2:e.drawBlind(e,a,e.circleX,e.circleY,e.circleRadius,e.privateEyesYLevel,.8,FPhi.UserControl.Color.blindColor,e.rm.translate("message_blink")),e.drawButtonClose(e,a,"Extractor");break;case FPhi.UserControlState.Liveness3:var d=0;d=e.actualTime-e.clockLiveness3,d=.2*(d/(1e3*e.liveness3Time)),.2<d&&(d=.2),e.drawBlind(e,a,e.circleX,e.circleY,e.circleRadius,e.privateEyesYLevel,.8+d,FPhi.UserControl.Color.blindColor,""),e.drawButtonClose(e,a,"Extractor");break;case FPhi.UserControlState.WaitingEyeDetection:if(null==e.clockEyeDetectionDetected){var v=e.actualTime-e.clockEyeDetection,d=0;1e3>v?d=1:(d=(v-1e3)/(1e3*e.liveness1Time),0>d?d=0:1<d&&(d=1),d=1-d),e.drawBlind(e,a,e.circleX,e.circleY,e.circleRadius,e.privateEyesYLevel,d,FPhi.UserControl.Color.blindColor,"")}else{var v=e.actualTime-e.clockEyeDetectionDetected,d=.3*(v/(1e3*e.liveness3Time));0>d?d=0:.3<d&&(d=.3),e.drawBlind(e,a,e.circleX,e.circleY,e.circleRadius,e.privateEyesYLevel,1-d,FPhi.UserControl.Color.blindColor,"")}if(!e.faceAvailableDelayed){var c=e.rm.getSetupColor("facephi-widget-conf","","color_warning_message"),h=e.rm.translate("error_message_face");e.showWarningMessage(e,a,h,c)}e.drawButtonClose(e,a,"Extractor");break;case FPhi.UserControlState.Extracting:var m=e.rm.getSetupColor("facephi-widget-conf","","color_progress_bar");if(!e.faceAvailableDelayed){var c=e.rm.getSetupColor("facephi-widget-conf","","color_warning_message"),h=e.rm.translate("error_message_face");e.showWarningMessage(e,a,h,c),m=c}else{var p=.2*o;a.save(),a.beginPath(),a.arc(e.circleX,.73*s+p/2,p/2,0,2*r,!1),a.clip(),a.drawImage(e.videoPlayer,o/2-p/2,.73*s,p,p),a.restore()}var d=e.actualTime-e.clockExtraction+e.extractionTimePartial;d/=1e3*e.extractionTime,e.extractionMode==FPhi.UserControlMode.Authenticate&&(d=d*d*(3-2*d)),a.beginPath(),a.strokeStyle=m;e.rm.getSetupFloat("facephi-widget-conf","","width_progress_bar");a.lineWidth=e.rm.getSetupFloat("facephi-widget-conf","","width_progress_bar"),a.lineCap="round",a.arc(e.circleX,e.circleY,e.circleRadius-a.lineWidth/2+.5,-r/2,2*r*d-r/2),a.stroke(),e.drawButtonClose(e,a,"Extractor");break;case FPhi.UserControlState.InitialTip:e.drawBackground(e,a,"RegistrationTips"),a.fillStyle=e.rm.getSetupColor("RegistrationTips","background","pagination_separator"),a.fillRect(0,s-e.buttonHeight-1,o,1);var f=e.rm.translate("registration_tips_title"),C=e.rm.getSetupFloat("RegistrationTips","tip","font_size"),S=e.rm.getSetupResourceId("RegistrationTips","tip","font"),x=e.rm.getSetupColor("RegistrationTips","tip","color");e.drawStringMultiline(e,a,f,.75*s,x,S,C),f=e.rm.translate("registration_tips_detail"),C=e.rm.getSetupFloat("RegistrationTips","tip_detail","font_size"),S=e.rm.getSetupResourceId("RegistrationTips","tip_detail","font"),x=e.rm.getSetupColor("RegistrationTips","tip_detail","color"),e.drawStringMultiline(e,a,f,.81*s,x,S,C),a.save(),a.beginPath(),a.arc(e.circleX,e.circleY,e.circleRadius,0,2*r,!1),a.clip(),a.drawImage(e.videoPlayer,e.circleX-e.circleRadius,e.circleY-e.circleRadius,2*e.circleRadius,2*e.circleRadius),a.restore();var w=190*e.canvasSizeFactor,E=38*e.canvasSizeFactor;e.drawButton(e,a,{x:30*e.canvasSizeFactor,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"RegistrationTips","button_skip"),e.drawButton(e,a,{x:o-30*e.canvasSizeFactor-w,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"RegistrationTips","button_next"),e.drawButtonClose(e,a,"RegistrationTips");break;case FPhi.UserControlState.CycleTip:case FPhi.UserControlState.ImproveWizard:e.drawBackground(e,a,"FaceMovementTips"),a.fillStyle=e.rm.getSetupColor("FaceMovementTips","background","pagination_separator"),a.fillRect(0,s-e.buttonHeight-1,o,1);var f=e.rm.translate("face_movement_tips_title"),C=e.rm.getSetupFloat("FaceMovementTips","tip","font_size"),S=e.rm.getSetupResourceId("FaceMovementTips","tip","font"),x=e.rm.getSetupColor("FaceMovementTips","tip","color");e.drawStringMultiline(e,a,f,.75*s,x,S,C),f=e.rm.translate("face_movement_tips_detail"),C=e.rm.getSetupFloat("FaceMovementTips","tip_detail","font_size"),S=e.rm.getSetupResourceId("FaceMovementTips","tip_detail","font"),x=e.rm.getSetupColor("FaceMovementTips","tip_detail","color"),e.drawStringMultiline(e,a,f,.81*s,x,S,C),a.save(),a.beginPath(),a.arc(e.circleX,e.circleY,e.circleRadius,0,2*r,!1),a.clip(),a.drawImage(e.videoPlayer,e.circleX-e.circleRadius,e.circleY-e.circleRadius,2*e.circleRadius,2*e.circleRadius),a.restore();var w=190*e.canvasSizeFactor,E=38*e.canvasSizeFactor;e.drawButton(e,a,{x:30*e.canvasSizeFactor,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"FaceMovementTips","button_back"),e.drawButton(e,a,{x:o-30*e.canvasSizeFactor-w,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"FaceMovementTips","button_done"),e.drawButtonClose(e,a,"FaceMovementTips");break;case FPhi.UserControlState.WaitingFaceStart:var m=e.rm.getSetupColor("facephi-widget-conf","","color_progress_bar");e.faceAvailableDelayed||(m=e.rm.getSetupColor("facephi-widget-conf","","color_warning_message")),a.beginPath(),a.strokeStyle=m,a.lineWidth=e.rm.getSetupFloat("facephi-widget-conf","","width_progress_bar"),a.lineCap="round",a.arc(e.circleX,e.circleY,e.circleRadius-a.lineWidth/2+.5,0,2*r),a.stroke();var f=e.rm.translate("start_extractor_title"),C=e.rm.getSetupFloat("StartExtractor","text","font_size"),S=e.rm.getSetupResourceId("StartExtractor","text","font"),x=e.rm.getSetupColor("StartExtractor","text","color");e.drawStringMultiline(e,a,f,.81*s,x,S,C);var w=190*e.canvasSizeFactor,E=38*e.canvasSizeFactor;e.drawButton(e,a,{x:.5*o-.5*w,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"StartExtractor","button_start"),e.extractionMode==FPhi.UserControlMode.Register&&e.drawButtonInfo(e,a,"StartExtractor"),e.drawButtonClose(e,a,"StartExtractor");break;case FPhi.UserControlState.ShowResults:e.drawBackground(e,a,"Results");var U=e.getGraphicalScore(e.lastExtractionResult.templateScore),T=e.rm.getSetupColor("facephi-widget-conf","","color_quality_excellent");.33>=U?T=e.rm.getSetupColor("facephi-widget-conf","","color_quality_low"):.66>=U&&(T=e.rm.getSetupColor("facephi-widget-conf","","color_quality_good"));var v=(e.actualTime-e.clockShowResults)/1e3,R=v/(1+1.5*U);1<R&&(R=1),R*=2-R,R=.5>R?2*R*R:-1+(4-2*R)*R,a.beginPath(),a.fillStyle="rgba(249,249,249,1)",a.arc(e.circleX,e.circleY,e.circleRadius,-r/2,2*r-r/2),a.fill(),a.beginPath(),a.strokeStyle=T,a.lineWidth=e.rm.getSetupFloat("facephi-widget-conf","","width_progress_bar"),a.lineCap="round",a.arc(e.circleX,e.circleY,e.circleRadius-.5*(a.lineWidth/2),-r/2,2*r*U*R-r/2),a.stroke();var L="",F="";1<=U?(L=e.rm.translate("results_quality_excellent"),F=e.rm.translate("results_message_excellent")):.333<=U?(L=e.rm.translate("results_quality_good"),F=e.rm.translate("results_message_good")):(L=e.rm.translate("results_quality_low"),F=e.rm.translate("results_message_low"));var I=L;fontSize1=e.rm.getSetupFloat("Results","text_result","font_size"),fontName1=e.rm.getSetupResourceId("Results","text_result","font"),e.drawStringMultiline(e,a,I,e.circleY-5,T,fontName1,fontSize1);var b=e.rm.translate("results_quality_message");fontSize2=e.rm.getSetupFloat("Results","text_quality","font_size"),fontName2=e.rm.getSetupResourceId("Results","text_quality","font"),e.drawStringMultiline(e,a,b,e.circleY+5+fontSize2,T,fontName2,fontSize2);var v=(e.actualTime-e.clockShowResults)/1e3;if(1<v){var W=2*(v-1);1<W&&(W=1);var k=e.rm.getSetupColorWithAlpha("Results","tip","color",W);fontSize1=e.rm.getSetupFloat("Results","tip","font_size"),fontName1=e.rm.getSetupResourceId("Results","tip","font"),e.drawStringMultiline(e,a,F,.81*e.canvasHeight,k,fontName1,fontSize1)}var w=190*e.canvasSizeFactor,E=38*e.canvasSizeFactor;1>U?(e.drawButton(e,a,e.reduceRect({x:0,y:s-e.buttonHeight,width:o/2,height:e.buttonHeight},.2),"Results","button_repeat"),e.drawButton(e,a,e.reduceRect({x:o/2,y:s-e.buttonHeight,width:o/2,height:e.buttonHeight},.2),"Results","button_finish")):e.drawButton(e,a,{x:.5*o-.5*w,y:s-.5*e.buttonHeight-.5*E,width:w,height:E},"Results","button_finish");break;case FPhi.UserControlState.WizardComplete:e.drawBackground(e,a,"Success"),a.save(),a.beginPath(),a.arc(e.circleX,e.circleY,e.circleRadius,0,2*r,!1),a.clip(),a.drawImage(e.videoPlayer,e.circleX-e.circleRadius,e.circleY-e.circleRadius,2*e.circleRadius,2*e.circleRadius),a.restore();var _=e.rm.getSetupResourceId("Success","logo_large","value"),D=e.rm.getImage(_),M=e.canvasSizeFactor*e.rm.getImageScale();a.drawImage(D,e.canvasWidth/2-D.width*M/2,e.canvasHeight-D.height*M-10,D.width*M,D.height*M);break;case FPhi.UserControlState.Errors:a.fillStyle="white",a.fillRect(0,0,o,s),f=e.livenessErrorString,fontHeight=15*e.fontSizeFactor;var S=e.rm.getSetupResourceId("facephi-widget-conf","","font_warning_message");a.font=fontHeight+"px '"+S+"'",a.fillStyle="black";for(var P=f.split("\n"),B=0;B<P.length;B++){e.adaptText(90*o/100,a,f,40*e.fontSizeFactor+"px '"+S+"'");var i=a.measureText(P[B]),H=330*e.canvasSizeFactor+fontHeight*B;a.fillText(P[B],o/2-i.width/2,H)}var y=e.livenessErrorImage,l=e.scaleRect({width:y.width,height:y.height},{x:.03*o,y:.378*s,width:.94*o,height:.1*s},!0);a.drawImage(y,l.x,l.y,l.width,l.height),e.drawButton(e,a,{x:0,y:s-e.buttonHeight,width:o,height:e.buttonHeight},"Results","button_finish");}if(a.restore(),e.debug){var z=1;a.font="12px Verdana",a.fillStyle="gray",a.fillText("Version: "+e.extractorVersion,0,20*z),z++,a.fillText("FPS: "+e.fps.toFixed(2),0,20*z),z++,a.fillText("FPS Extractor: "+e.fpse.toFixed(2),0,20*z),z++,a.fillText("Camera size: "+e.cameraWidth+"x"+e.cameraHeight+"px",0,20*z),z++,a.fillText("Canvas size: "+o+"x"+s+"px",0,20*z),z++,a.fillText("Status: "+FPhi.UserControlStateInv[e.status],0,20*z),z++,a.fillText("Images: "+e.privateImages.length,0,20*z),z++,a.fillText("Face available: "+e.faceAvailable,0,20*z),z++,a.fillText("EyesYLevel: "+Math.round(e.privateEyesYLevel),0,20*z),z++;var A=e.lastDetectResult;if(null!=A){if("undefined"!=typeof A.face){a.fillText("Face: ["+A.face.x+","+A.face.y+","+A.face.width+","+A.face.height+"]",0,20*z),z++,a.beginPath(),a.lineWidth="3",a.strokeStyle="red";var O=e.fromCameraToScreen(e,{x:A.face.x,y:A.face.y,width:A.face.width,height:A.face.height});a.rect(O.x,O.y,O.width,O.height),a.stroke()}if("undefined"!=typeof A.leftEye){a.beginPath(),a.lineWidth="6",a.strokeStyle="red";var O=e.fromCameraToScreen(e,{x:A.leftEye.x,y:A.leftEye.y,width:1,height:1});a.rect(O.x,O.y,O.width,O.height),a.stroke()}if("undefined"!=typeof A.rightEye){a.beginPath(),a.lineWidth="6",a.strokeStyle="red";var O=e.fromCameraToScreen(e,{x:A.rightEye.x,y:A.rightEye.y,width:1,height:1});a.rect(O.x,O.y,O.width,O.height),a.stroke()}}}e.status==FPhi.UserControlState.Off?e.setOffInterface(a,e.cameraContainer,e.canvasWidth):setTimeout(e.draw,e.samplePeriod,e,t,a)},reduceRect:function(e,t){var a=e.width*(1-t),i=e.height*(1-t);return e.x+=(e.width-a)/2,e.y+=(e.height-i)/2,e.width=a,e.height=i,e},drawStringMultiline:function(e,t,i,r,o,s,n){var l=i.split("\n");t.imageSmoothingEnabled=!1,n=Math.round(n*e.fontSizeFactor),t.font="normal "+n+"px '"+s+"'",t.fillStyle=o;for(var c=0;c<l.length;c++)dim=t.measureText(l[c]),t.fillText(l[c],e.canvasWidth/2-dim.width/2,r+c*(n+1))},setOffInterface:function(e,t,a){e.beginPath(),e.lineWidth="5",e.fillStyle="gray",e.fillRect(0,0,a,a),e.stroke()},adaptText:function(e,t,a,i){t.font=i;var r=t.measureText(a).width;if(r>e){var o=i.indexOf("px"),s=i.substring(0,o);return s--,i=s+i.substring(o,i.length),t.font=i,this.adaptText(e,t,a,i)}return!0},reflectedX:function(e,t){return e-t},iterateAutomata:function(e){switch(e.status){case FPhi.UserControlState.WaitForWasmReady:0==e.queuedCommands&&e.wasmReady&&(e.extractionMode==FPhi.UserControlMode.Register?e.setStatus(e,FPhi.UserControlState.InitialTip):e.setStatus(e,FPhi.UserControlState.WaitingFaceStart));break;case FPhi.UserControlState.Nothing:break;case FPhi.UserControlState.InitialTip:e.evaluateScenarioTimeout(e);break;case FPhi.UserControlState.CycleTip:e.evaluateScenarioTimeout(e);break;case FPhi.UserControlState.ShowResults:e.evaluateScenarioTimeout(e);break;case FPhi.UserControlState.WaitingFace:if(0==e.extractor.QueuedCommands){var t=e.getImageData(e.privateCanvas);e.privateLastImage=t,e.extractor.Detect(t.width,t.height,t.pixels.data.buffer,FPhi.ImageFormat.RGBA_32bpp)}e.evaluateScenarioTimeout(e);break;case FPhi.UserControlState.WaitingFaceStart:if(0==e.queuedCommands&&e.wasmReady){var a=e.getImageData(e.privateCanvas);e.privateLastImage=a,e.postMessage(e,{cmd:"detect",data:a.pixels.data,width:a.width,height:a.height,format:FPhi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e)}break;case FPhi.UserControlState.WaitingEyeDetection:if(performance.now()-e.clockEyeDetection>e.detectionTimeout){e.livenessErrorString=e.translate(e,"timeout"),e.livenessErrorImage=e.imageTimeout,e.setStatus(e,FPhi.UserControlState.Errors);break}var i=performance.now()-e.clockEyeDetection;if(1e3<i&&null==e.clockEyeDetectionDetected&&i<1e3+1e3*e.liveness1Time)break;if(i>1e3+1e3*e.liveness1Time&&null!=e.clockEyeDetectionDetected){e.setStatus(e,FPhi.UserControlState.Liveness1);break}if(null!=e.clockEyeDetectionDetected&&performance.now()-e.clockEyeDetectionDetected>1e3*e.liveness3Time&&e.setStatus(e,FPhi.UserControlState.Liveness2),null==e.clockEyeDetectionDetected&&0==e.queuedCommands&&e.wasmReady){var a=e.getImageData(e.privateCanvas);e.privateLastImage=a,e.postMessage(e,{cmd:"detect",data:a.pixels.data,width:a.width,height:a.height,format:FPhi.ImageFormat.RGBA_32bpp}),e.evaluateScenarioTimeout(e)}break;case FPhi.UserControlState.Liveness1:performance.now()-e.clockLiveness1>1e3*e.liveness1Time&&e.setStatus(e,FPhi.UserControlState.Liveness2);break;case FPhi.UserControlState.Liveness2:if(0==e.queuedCommands&&e.wasmReady){var t=e.getImageData(e.privateCanvas);e.privateLivenessImageTemp=t,e.postMessage(e,{cmd:"livenessTimerAdd",milliseconds:performance.now()-e.clockLiveness2})}break;case FPhi.UserControlState.Liveness3:null!=e.clockLiveness3_finish&&performance.now()-e.clockLiveness3_finish>1e3*e.liveness3Time&&e.setStatus(e,FPhi.UserControlState.WaitingEyeDetection);break;case FPhi.UserControlState.Extracting:if(e.faceAvailableDelayed||(e.extractionTimePartial+=e.actualTimePrev-e.clockExtraction,e.clockExtraction=e.actualTime),0==e.queuedCommands)if(e.actualTime-e.clockExtractionPure>e.detectionTimeout&&0==e.privateImages.length)e.livenessErrorString=e.translate(e,"timeout"),e.livenessErrorImage=e.imageTimeout,e.setStatus(e,FPhi.UserControlState.Errors);else if(!(e.actualTime-e.clockExtraction+e.extractionTimePartial<1e3*e.extractionTime||0==this.privateImages.length))e.extractionMode==FPhi.UserControlMode.Register?e.setStatus(e,FPhi.UserControlState.ShowResults):e.livenessMode==FPhi.LivenessMode.Blink?e.setStatus(e,FPhi.UserControlState.Liveness1):e.setStatus(e,FPhi.UserControlState.Finish);else if(e.actualTime-e.clockExtractionPure>e.extractionTimeout)e.livenessErrorString=e.translate(e,"timeout"),e.livenessErrorImage=e.imageTimeout,e.setStatus(e,FPhi.UserControlState.Errors);else{var a=e.getImageData(e.privateCanvas);e.privateLastImage=a,e.postMessage(e,{cmd:"extractNextSmart",data:a.pixels.data,width:a.width,height:a.height,format:FPhi.ImageFormat.RGBA_32bpp})}break;case FPhi.UserControlState.WizardComplete:performance.now()-e.clockWizardCompleted>1e3*e.sendingTimeout&&e.setStatus(e,FPhi.UserControlState.Finish);}},evaluateScenarioTimeout:function(e){0<e.sceneTimeout&&performance.now()-e.clockNewScenario>1e3*e.sceneTimeout&&(e.livenessErrorString=e.translate(e,"timeout"),e.livenessErrorImage=e.imageTimeout,e.setStatus(e,FPhi.UserControlState.Errors))},getVideoSources:function(e){navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)}):MediaStreamTrack.getSources(function(t){videoSourceId=t.filter(function(e){return"video"==e.kind}).map(function(e){return e.id}),selectedSource=videoSourceId[0],e.setVideoInput(e)})},getScriptPath:function(e){var t,a=document.getElementsByTagName("script"),i=0;for(t=0;t<a.length;t++)-1<a[t].src.indexOf(e)&&(i=t);return a[i].src.split("/").slice(0,-1).join("/")+"/"},translate:function(e,t){if("es"==e.language){var a=FPhi.UserControl.Language.es[t];return void 0==a?t:a}if("en"==e.language){var a=FPhi.UserControl.Language.en[t];return void 0==a?t:a}return t},distAlgSustitution:function(e,t,i){for(var r,o,s=Number.MAX_VALUE,n=1;n<t.length;n++){o=t.slice(),o[n]=i,o.sort(function(e,t){return e.time-t.time});var a=e.desviacionTipica(e,o);a<s&&(s=a,r=o)}return r},desviacionTipica:function(e,t){for(var i,r=e.media(e,t),o=0,s=1;s<t.length;s++)i=t[s].time-t[s-1].time,o+=(i-r)*(i-r);return o=Math.sqrt(o/(t.length-2)),o},media:function(e,t){for(var i,r=0,o=1;o<t.length;o++)i=t[o].time-t[o-1].time,r+=i;return r/(t.length-1)},OnResourceManagerStatus:function(e,t){t&&e.setStatus(e,FPhi.UserControlState.WaitForWasmReady)},videoLoaded:function(t){this.cameraWidth=t.target.videoWidth,this.cameraHeight=t.target.videoHeight},videoFrame:function(t){var e=this.canvasVideoPlayer.getContext("2d");e.drawImage(t.target,0,0)}};function arrayBufferToBase64(e){for(var t="",a=new Uint8Array(e),r=a.byteLength,o=0;o<r;o++)t+=String.fromCharCode(a[o]);return window.btoa(t)}var facePhiUserControlWasm={GetPluginEnabled:function(){return null!=privateFacePhiConfig.WasmControl},OnExtractionFinish:function(e){var t=null,a=null;e.detail.template&&0<e.detail.template.byteLength&&(t=arrayBufferToBase64(e.detail.template)),0<e.detail.images.length&&(a=e.detail.images);var i={Template:t,Images:a};facePhiUserControl.events.ExtractionFinished(i)},OnLivenessError:function(e){var t=null;-1<e.detail.livenessErrorType&&(t={LivenessErrorType:e.detail.livenessErrorType}),facePhiUserControl.events.LivenessError(t)},OnTimeoutErrorButtonClick:function(){facePhiUserControl.events.TimeoutErrorButtonClick()},OnLivenessErrorButtonClick:function(){facePhiUserControl.events.LivenessErrorButtonClick()},OnExceptionCaptured:function(e){var t=null,a=null;e.detail.message&&(t=e.detail.message),-1<e.detail.exceptionType&&(a=e.detail.exceptionType);var i={Message:t,ExceptionType:a};facePhiUserControl.events.ExceptionCaptured(i)},OnExtractionTimeout:function(){facePhiUserControl.events.ExtractionTimeout()},OnUserCancel:function(){facePhiUserControl.events.CancelledDetected()}},privateFacePhiConfig={WasmControl:null};FacePhiShowWasm=function(){var e=FPhi.UserControl.prototype.getScriptPath("FPhi.UC.wasm.js")+"FPhi.Widget.Resources/";null==privateFacePhiConfig.WasmControl?(privateFacePhiConfig.WasmControl=new FPhi.UserControl(facePhiUserControl.config.divId,640,480,facePhiUserControlWasm.OnExtractionFinish,facePhiUserControlWasm.OnUserCancel,facePhiUserControlWasm.OnExceptionCaptured,facePhiUserControlWasm.OnExtractionTimeout,facePhiUserControlWasm.OnLivenessError,facePhiUserControlWasm.OnLivenessErrorButtonClick,facePhiUserControlWasm.OnTimeoutErrorButtonClick,facePhiUserControl.config.culture,e,[163,326,489],facePhiUserControl.config.width,facePhiUserControl.config.width),privateFacePhiConfig.WasmControl.cropImage=facePhiUserControl.config.cropImage,privateFacePhiConfig.WasmControl.cropFactor=facePhiUserControl.config.cropFactor,privateFacePhiConfig.WasmControl.resizeFactor=facePhiUserControl.config.resizeFactor,privateFacePhiConfig.WasmControl.sceneTimeout=facePhiUserControl.config.sceneTimeout,privateFacePhiConfig.WasmControl.debug=facePhiUserControl.config.debug,facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Authenticate&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Authenticate),facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Register&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Register),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.Blink&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.Blink),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.None&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.None),privateFacePhiConfig.WasmControl.status==FPhi.UserControlState.Off&&privateFacePhiConfig.WasmControl.Start()):(facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Authenticate&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Authenticate),facePhiUserControl.config.extractionMode==facePhiUserControlType.extractionMode.Register&&(privateFacePhiConfig.WasmControl.extractionMode=FPhi.UserControlMode.Register),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.Blink&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.Blink),facePhiUserControl.config.livenessMode==facePhiUserControlType.livenessMode.None&&(privateFacePhiConfig.WasmControl.livenessMode=FPhi.LivenessMode.None),privateFacePhiConfig.WasmControl.status==FPhi.UserControlState.Off&&privateFacePhiConfig.WasmControl.Start())};